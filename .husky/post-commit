#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# BMAD Auto-sync after commits
# Automatically syncs story status when story files are modified

echo "üîÑ Checking for BMAD story updates..."

# Check if any story files were modified in this commit
if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "docs/stories/\|docs/epics/\|docs/sprints/"; then
    echo "üìä BMAD documentation changed, syncing status..."

    # Run sync script
    npm run bmad:sync 2>/dev/null || npx tsx scripts/sync-bmad-status.ts 2>/dev/null

    if [ $? -eq 0 ]; then
        echo "‚úÖ BMAD status synchronized successfully"
    else
        echo "‚ö†Ô∏è  BMAD sync failed - run 'npm run bmad:sync' manually"
    fi
else
    echo "‚ú® No BMAD documentation changes detected"
fi

# Check commit message for story references
COMMIT_MSG=$(git log -1 --pretty=%B)
if echo "$COMMIT_MSG" | grep -q "\[STORY-\|feat(STORY-\|fix(STORY-"; then
    STORY_REF=$(echo "$COMMIT_MSG" | grep -o "STORY-[0-9]\+\.[0-9]\+" | head -1)
    if [ ! -z "$STORY_REF" ]; then
        echo "üìù Story reference found: $STORY_REF"
        echo "   Status will be updated on next sync"
    fi
fi